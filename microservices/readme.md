#  Микросервисное Приложение

## Описание проекта

Текстовый сканер - веб-приложение, разработанное по микросервисной архитектуре, которое позволяет анализировать текстовые файлы (.txt) студенческих отчетов. Система выполняет комплексный анализ, включая подсчёт статистики и поиск плагиата.

## Функциональность

- **Анализ текста**: 
  - Подсчет количества абзацев
  - Подсчет количества слов
  - Подсчет количества символов
- **Проверка на плагиат**: сравнение загруженных файлов по хэшу с ранее отправленными для выявления 100% совпадений
- **Визуализация данных**: генерация облака слов на основе анализируемого текста

## Архитектура системы

Для каждого микросервиса была выделенна своя БД для достижения полной изоляции.

Система построена на основе трех взаимодействующих микросервисов:

### 1. API Gateway

**Назначение**
Центральная точка входа для всех клиентских запросов

**Описание архитектуры**
- /api - в папке содержатся обработчики запросов 
- /services/gateway - отвечает за общение с микросервисами через http запросы и обрабатывает их ответы, возвращая нужные данные

### 2. Storage Service

**Назначение**
Управление хранением и доступом к файлам

**Описание архитектуры**
- /content - сюда сохраняются файлы. Папка привязана к volume докера, чтобы контент не сбрасывался при перезапуске контейнеров.
- /migrations - тут лежит SQL файл для создания таблицы в PostgreSQL. Выполняется при запуске программы
- /api - в папке содержатся обработчики запросов, а также модели для сериализации и десериализации данных для запросов в файле dto. 
- /services
  - file_service - сервис для работы с файловой системой - сохранение, получение, генерация хэша файла с помощью SHA256
  - storage_service - основной сервис приложения для выполнения главного функционала самого микросервиса. Вызывается в API обработчиках.
- /repositories/repo - Репозиторий для работы с базой данных. Создается в едином экземпляре в main и передается по ссылке через Arc. (аналог atomic shared pointer из c++)
- /models - туда я вынес структуры хранения данных о файле для БД и для работы с проверкой на плагиат

### 3. File Analysis Service

**Назначение**
Анализ текстовых файлов

**Описание архитектуры**

- /images - сюда сохраняются картинки. Папка привязана к volume докера, чтобы контент не сбрасывался при перезапуске контейнеров.
- /migrations - тут лежит SQL файл для создания таблицы в PostgreSQL. Выполняется при запуске программы
- /api - в папке содержатся обработчики запросов (слой Presentation)
- /infrastructure
  - repo - Репозиторий для работы с базой данных. Создается в едином экземпляре в main и передается по ссылке через Arc. (аналог atomic shared pointer из c++)
  - storage_repo - Репозиторий для общения с микросервисом Storage.
  - words_repo - Репозиторий для работы с API wordcloud. Вынес его в инфраструктуру, так как идет работа со сторонним источником
- /models - туда я вынес структуры для работы с микросервисом и для данных об анализе файла
- /services
  - analysis_service - основной сервис приложения для выполнения главного функционала самого микросервиса. Вызывается в API обработчиках.
  - file_service - сервис для работы с файловой системой - сохранение, получение, генерация хэша файла с помощью SHA256

## Запуск проекта

### Инструкция по запуску

1. Клонировать репозиторий
2. Создать .env файл в корневой директории по примеру .env.example
3. Выполнить команду:

```bash
docker compose up -d
```

4. Приложение будет доступно по адресу [http://localhost:8000](http://localhost:8000)
5. Swagger-документация: [http://localhost:8000/swagger-ui/](http://localhost:8000/swagger-ui/)
6.  Swagger-документация Storage: [http://localhost:8001/swagger-ui/](http://localhost:8001/swagger-ui/)
7.  Swagger-документация Analysis: [http://localhost:8002/swagger-ui/](http://localhost:8002/swagger-ui/)


## Обработка ошибок

Система реализует устойчивость к сбоям:

- Если Storage Service недоступен, API Gateway возвращает сообщение о временной недоступности хранилища
- Если File Analysis Service недоступен, загрузка и хранение файлов продолжают работать, но анализ временно недоступен
- Все микросервисы имеют механизмы перезапуска при сбоях (restart: always)


## Тестирование

В связи с тем, что проект представляет Web API, я решил произвести интеграционное тестирование модулей. 

Для прохождения тестов необходимо развернуть приложение в докере.

**Тесты:**
- Проверка на сохранение файла в локальном хранилище
- Проверка на сохранение изображения в локальном хранилище 
- Проверка правильности анализа текста 
- Проверка загрузки одинаковых файлов
- Проверка загрузки и затем получения контента файла

**Запуск тестов**

Важно: необходимо запустить всё приложение для тестирования.

Для запуска тестов запустить следующие команды из корневой директории:

- `cd storage-service && cargo test`
- `cd file-analysis && cargo test`

### Примечания

Для удобства проверки я вынес порты микросервисов наружу, но по-хорошему надо их оставить только во внутренней сети Docker (заменить ports на expose). Базы данных недоступны извне - только внутри докер сети.

Проверка на плагиат происходит путем поиска хэша как у файла в бд. Для этого сделал отдельный маршрут у сервиса Storage /plagiarism, который возвращает true или false в зависимости от результата проверки файлов.
